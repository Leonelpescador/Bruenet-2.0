{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Crear Pedido para la Mesa {{ mesa.numero_mesa }}</h1>

    <div class="form-container" style="max-width: 800px; margin: 0 auto;">
        <form id="pedidoForm" method="post">
            {% csrf_token %}
            <div class="form-group mb-3">
                <label for="mesa">Mesa</label>
                <select id="mesa" name="mesa" class="form-control" required>
                    <option value="{{ mesa.id }}" selected>Mesa {{ mesa.numero_mesa }}</option>
                </select>
            </div>
            <div class="form-group mb-3">
                <label for="estado">Estado</label>
                <select id="estado" name="estado" class="form-control">
                    <option value="preparando">Preparando</option>
                </select>
            </div>

            <h3 class="text-center mt-4">Seleccionar Platos:</h3>
            <div class="form-group mb-3">
                <label for="categoria">Filtrar por Categoría:</label>
                <select id="categoria" class="form-control categoria-select" onchange="filtrarPlatos()">
                    <option value="">Selecciona una Categoría</option>
                    {% for categoria in categorias %}
                        <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="platos-container" class="row">
                <!-- Aquí se mostrarán los platos filtrados por categoría -->
            </div>

            <h3 class="text-center mt-4">Pedido Seleccionado:</h3>
            <div id="pedido-seleccionado">
                <!-- Aquí se agregan los platos seleccionados con cantidad -->
            </div>

            <div class="text-center mt-3">
                <button type="submit" class="btn btn-primary">Crear Pedido</button>
                <a href="{% url 'home' %}" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script type="text/javascript">
    // Función para filtrar platos por categoría
    function filtrarPlatos() {
        var categoriaId = document.querySelector('.categoria-select').value;
        var platosContainer = document.getElementById('platos-container');

        fetch(`{% url 'filtrar_platos_por_categoria' %}?categoria_id=${categoriaId}`)
            .then(response => response.text())
            .then(data => {
                platosContainer.innerHTML = data;  // Renderizar los platos en el contenedor
            });
    }

    // Función para agregar platos al pedido
    function agregarAlPedido(platoId, nombrePlato, precioPlato, imagenPlato) {
        var pedidoSeleccionado = document.getElementById('pedido-seleccionado');
        var cantidad = 1; // Iniciar la cantidad en 1

        // Verificar si el plato ya está agregado
        var existe = pedidoSeleccionado.querySelector(`div[data-id="${platoId}"]`);
        if (!existe) {
            // Crear el HTML para agregar el plato seleccionado al pedido
            var pedidoHtml = `
                <div class="pedido-item mb-3" data-id="${platoId}">
                    <div class="d-flex justify-content-between">
                        <img src="${imagenPlato}" alt="${nombrePlato}" style="width: 50px; height: 50px;">
                        <div class="pedido-nombre">${nombrePlato}</div>
                        <div class="pedido-precio">${precioPlato}</div>
                        <div class="pedido-cantidad">
                            <button class="btn btn-sm btn-danger decremento" onclick="decrementarCantidad(this)">-</button>
                            <input type="text" value="${cantidad}" readonly style="width: 30px; text-align: center;">
                            <button class="btn btn-sm btn-success incremento" onclick="incrementarCantidad(this)">+</button>
                        </div>
                    </div>
                </div>
            `;
            pedidoSeleccionado.insertAdjacentHTML('beforeend', pedidoHtml);
        }
    }

    // Incrementar la cantidad de platos
    function incrementarCantidad(button) {
        var input = button.previousElementSibling;
        input.value = parseInt(input.value) + 1;
    }

    // Decrementar la cantidad de platos
    function decrementarCantidad(button) {
        var input = button.nextElementSibling;
        if (parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
        }
    }

    // Enviar el pedido al servidor
    document.getElementById('pedidoForm').onsubmit = function(event) {
        event.preventDefault(); // Prevenir el envío tradicional del formulario

        var pedidoData = [];
        var pedidoSeleccionado = document.getElementById('pedido-seleccionado');
        pedidoSeleccionado.querySelectorAll('.pedido-item').forEach(function(item) {
            var platoId = item.getAttribute('data-id');
            var cantidad = item.querySelector('input').value;
            pedidoData.push({ plato_id: platoId, cantidad: cantidad });
        });

        if (pedidoData.length === 0) {
            alert("No has seleccionado ningún plato.");
            return;
        }

        // Enviar el pedido solo cuando se haga clic en "Crear Pedido"
        fetch("{% url 'crear_pedido' mesa.id %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify({ pedido: pedidoData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Pedido creado con éxito.');
                window.location.href = "{% url 'pedidos_activos' %}";
            } else {
                alert('Error al crear el pedido: ' + data.error);
            }
        })
        .catch(error => {
            alert('Hubo un error al procesar el pedido. Por favor, intenta nuevamente.');
        });
    };
</script>
{% endblock %}
