{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center">Crear Pedido para la Mesa {{ mesa.numero_mesa }}</h1>

    <div class="form-container" style="max-width: 800px; margin: 0 auto;">
        <form id="pedidoForm" method="post">
            {% csrf_token %}
            <div class="form-group mb-3">
                {{ pedido_form.as_p }}
            </div>

            <h3 class="text-center mt-4">Seleccionar Platos:</h3>
            {{ formset.management_form }}

            <div id="formset-container">
                {% for form in formset %}
                <div class="detalle-pedido mb-3 p-3 bg-white rounded shadow-sm">
                    <div class="form-group mb-3">
                        <label for="categoria-{{ forloop.counter0 }}">Filtrar por Categoría:</label>
                        <select id="categoria-{{ forloop.counter0 }}" class="form-control categoria-select">
                            <option value="">Selecciona una Categoría</option>
                            {% for categoria in categorias %}
                                <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group mb-2">
                        {{ form.menu.label_tag }} 
                        {{ form.menu }}
                    </div>
                    <div class="form-group mb-2">
                        {{ form.cantidad.label_tag }} 
                        {{ form.cantidad }}
                    </div>
                    <div class="form-group mb-2">
                        {{ form.precio_unitario.label_tag }} 
                        {{ form.precio_unitario }}
                    
                {% endfor %}
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary">Crear Pedido</button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        var formsetContainer = $('#formset-container');
        var totalForms = $('#id_form-TOTAL_FORMS');

        function initializeCategoryFilter() {
            $('.categoria-select').off('change').on('change', function() {
                var categoriaId = $(this).val();
                var $menuSelect = $(this).closest('.detalle-pedido').find('select[id$="-menu"]');
                
                $.ajax({
                    url: "{% url 'filtrar_platos_por_categoria' %}",
                    data: {
                        'categoria_id': categoriaId
                    },
                    success: function(data) {
                        $menuSelect.html(data);
                    }
                });
            });
        }

        function initializeMenuChange() {
            formsetContainer.find('select[id$="-menu"]').off('change').on('change', function() {
                var platoId = $(this).val();
                var precioField = $(this).closest('.detalle-pedido').find('input[id$="-precio_unitario"]');

                if (platoId) {
                    $.ajax({
                        url: "{% url 'obtener_precio_plato' %}",
                        data: {
                            'menu_id': platoId
                        },
                        success: function(data) {
                            if (data.precio) {
                                precioField.val(data.precio);
                            }
                        }
                    });
                } else {
                    precioField.val('');
                }
            });
        }

        initializeCategoryFilter();
        initializeMenuChange();

        $('#add-form-btn').click(function() {
            var formCount = parseInt(totalForms.val());
            var newForm = formsetContainer.children().last().clone(false);
            var regex = new RegExp('form-' + (formCount - 1), 'g');

            newForm.html(newForm.html().replace(regex, 'form-' + formCount));
            newForm.find('input, select').val('');
            newForm.find('.categoria-select').attr('id', 'categoria-' + formCount);

            formsetContainer.append(newForm);
            totalForms.val(formCount + 1);

            initializeCategoryFilter();
            initializeMenuChange();
        });

        formsetContainer.on('click', '.remove-form-btn', function() {
            if (formsetContainer.children().length > 1) {
                $(this).closest('.detalle-pedido').remove();
                totalForms.val(parseInt(totalForms.val()) - 1);
            } else {
                alert("No puedes eliminar este formulario hasta que agregues otro plato.");
            }
        });

        $('#pedidoForm').submit(function(event) {
            event.preventDefault(); // Prevenir el envío tradicional del formulario
            
            $.ajax({
                url: "{% url 'crear_pedido' mesa.id %}",
                type: "POST",
                data: $(this).serialize(),
                success: function(response) {
                    if (response.success) {
                        if (confirm("¿Quieres agregar otro pedido?")) {
                            location.reload();
                        } else {
                            window.location.href = "{% url 'pedidos_activos' %}";
                        }
                    }
                }
            });
        });
    });
</script>
{% endblock %}
